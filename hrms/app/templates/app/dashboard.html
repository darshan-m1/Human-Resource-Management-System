{% extends 'app/base.html' %}
{% block content %}
<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-1 gradient-text">Dashboard Overview</h1>
        <p class="text-muted mb-0">
            <i class="bi bi-calendar-check me-1"></i>Welcome back, {{ request.user.get_full_name|default:request.user.username }}
        </p>
    </div>
    {% if is_ceo_or_hr %}
        <div class="btn-group">
            <a href="{% url 'app:create' %}" class="btn gradient-btn">
                <i class="bi bi-person-plus me-2"></i>Add Employee
            </a>
            <a href="{% url 'app:perflist' %}" class="btn btn-outline-primary">
                <i class="bi bi-graph-up me-2"></i>Performance
            </a>
        </div>
    {% endif %}
</div>

{% if is_ceo_or_hr %}
<!-- CEO/HR Dashboard -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="glass-card p-4 stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-2">Total Employees</h6>
                    <h2 class="mb-0">{{ object_list|length }}</h2>
                </div>
                <div class="rounded-circle bg-primary bg-opacity-10 p-3">
                    <i class="bi bi-people text-primary fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="glass-card p-4 stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-2">Departments</h6>
                    <h2 class="mb-0">{{ depts }}</h2>
                </div>
                <div class="rounded-circle bg-success bg-opacity-10 p-3">
                    <i class="bi bi-building text-success fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="glass-card p-4 stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-2">Managers</h6>
                    <h2 class="mb-0">{{ managers }}</h2>
                </div>
                <div class="rounded-circle bg-warning bg-opacity-10 p-3">
                    <i class="bi bi-person-badge text-warning fs-4"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="glass-card p-4 stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-2">Active Today</h6>
                    <h2 class="mb-0">{{ object_list|length|default:"15" }}</h2>
                </div>
                <div class="rounded-circle bg-info bg-opacity-10 p-3">
                    <i class="bi bi-activity text-info fs-4"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SEARCH AND FILTER SECTION -->
<div class="glass-card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-0">All Employees</h4>
            <p class="text-muted mb-0">Manage your organization's workforce</p>
        </div>
        <div>
            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">
                <i class="bi bi-people me-1"></i>{{ filter.qs.count }} employees
            </span>
        </div>
    </div>
    
    <!-- FILTER FORM -->
    <form method="get" class="mb-4">
        <div class="row g-3">
            <!-- SEARCH FIELD -->
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" 
                           name="search" 
                           class="form-control border-start-0" 
                           placeholder="Search by name or email..." 
                           value="{{ filter.form.search.value|default:'' }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search me-1"></i>Search
                    </button>
                </div>
            </div>
            
            <!-- DEPARTMENT FILTER -->
            <div class="col-md-3">
                <select name="department" class="form-select">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if filter.form.department.value == dept.id|stringformat:"i" %}selected{% endif %}>
                        {{ dept.department }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- ROLE FILTER -->
            <div class="col-md-3">
                <select name="role" class="form-select">
                    <option value="">All Roles</option>
                    {% for role_value, role_label in role_choices %}
                    <option value="{{ role_value }}" {% if filter.form.role.value == role_value %}selected{% endif %}>
                        {{ role_label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- QUICK FILTER BUTTONS - BEST APPROACH -->
                <!-- <div class="col-12">
                    <div class="d-flex align-items-center">
                        <small class="text-muted me-3">Quick Filters:</small>
                        <div class="btn-group btn-group-sm" role="group"> -->
                            <!-- Role Filter Buttons -->
                            <!-- <button type="button" 
                                    class="btn {% if request.GET.role == 'HR' %}btn-info{% else %}btn-outline-info{% endif %}"
                                    onclick="applyRoleFilter('HR')">
                                HR
                            </button>
                            
                            <button type="button" 
                                    class="btn {% if request.GET.role == 'DEVELOPER' %}btn-warning{% else %}btn-outline-warning{% endif %}"
                                    onclick="applyRoleFilter('DEVELOPER')">
                                Developer
                            </button>
                            
                            <button type="button" 
                                    class="btn {% if request.GET.role == 'TEAM LEAD' %}btn-success{% else %}btn-outline-success{% endif %}"
                                    onclick="applyRoleFilter('TEAM LEAD')">
                                Team Lead
                            </button>
                            
                            <button type="button" 
                                    class="btn {% if request.GET.role == 'INTERN' %}btn-primary{% else %}btn-outline-primary{% endif %}"
                                    onclick="applyRoleFilter('INTERN')">
                                Interns
                            </button> -->
                            
                            <!-- Clear Role Button
                            <button type="button" class="btn btn-outline-secondary" onclick="clearRoleFilter()">
                                <i class="bi bi-x-circle me-1"></i>Clear Role
                            </button> -->
                        <!-- </div>
                    </div>
                </div>
             -->
            <!-- ACTIVE FILTER BADGES -->
            <!-- {% if filter.form.search.value or filter.form.department.value or filter.form.role.value %}
            <div class="col-12">
                <div class="d-flex align-items-center flex-wrap gap-2">
                    <small class="text-muted">Active Filters:</small>
                    
                    {% if filter.form.search.value %}
                    <span class="badge bg-primary">
                        Search: {{ filter.form.search.value }}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'search' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                           class="text-white ms-1" style="text-decoration: none;">
                            <i class="bi bi-x"></i>
                        </a>
                    </span>
                    {% endif %}
                    
                    {% if filter.form.department.value %}
                    {% with dept_id=filter.form.department.value %}
                    <span class="badge bg-success">
                        Department: {% for dept in departments %}{% if dept.id|stringformat:"i" == dept_id %}{{ dept.department }}{% endif %}{% endfor %}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'department' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                           class="text-white ms-1" style="text-decoration: none;">
                            <i class="bi bi-x"></i>
                        </a>
                    </span>
                    {% endwith %}
                    {% endif %}
                    
                    {% if filter.form.role.value %}
                    <span class="badge bg-info">
                        Role: {{ filter.form.role.value }}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'role' %}{{ key }}={{ value }}&{% endif %}{% endfor %}" 
                           class="text-white ms-1" style="text-decoration: none;">
                            <i class="bi bi-x"></i>
                        </a>
                    </span>
                    {% endif %}
                    
                    <a href="?" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash me-1"></i>Clear All
                    </a>
                </div>
            </div>
            {% endif %} -->
        </div>
    </form>
    
    <!-- EMPLOYEES TABLE -->
    {% if filter.qs %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead class="bg-light">
                <tr>
                    <th class="border-top-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person me-2 text-primary"></i>Name
                        </div>
                    </th>
                    <th class="border-top-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-building me-2 text-primary"></i>Department
                        </div>
                    </th>
                    <th class="border-top-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-briefcase me-2 text-primary"></i>Role
                        </div>
                    </th>
                    <th class="border-top-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-diagram-3 me-2 text-primary"></i>Manager
                        </div>
                    </th>
                    <th class="border-top-0 text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for employee in filter.qs %}
                <tr class="hover-lift">
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-3">
                                <i class="bi bi-person text-primary"></i>
                            </div>
                            <div>
                                <strong>{{ employee.user.get_full_name }}</strong>
                                <div class="text-muted small">{{ employee.user.email|default:"No email" }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-primary bg-opacity-10 text-primary">
                            {{ employee.department }}
                        </span>
                    </td>
                    <td>
                        <span class="badge {% if employee.role == 'HR' %}bg-danger{% elif employee.role == 'Manager' %}bg-warning{% else %}bg-info{% endif %} bg-opacity-10 
                              {% if employee.role == 'HR' %}text-danger{% elif employee.role == 'Manager' %}text-warning{% else %}text-info{% endif %}">
                            {{ employee.role }}
                        </span>
                    </td>
                    <td>
                        {% if employee.reporting_to %}
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-success bg-opacity-10 p-1 me-2">
                                    <i class="bi bi-person-check text-success"></i>
                                </div>
                                {{ employee.reporting_to.user.get_full_name }}
                            </div>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{% url 'app:empupdate2' employee.id %}" class="btn btn-outline-warning" data-bs-toggle="tooltip" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <!-- <a href="#" class="btn btn-outline-info" data-bs-toggle="tooltip" title="View">
                                <i class="bi bi-eye"></i>
                            </a> -->
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- PAGINATION (Optional) -->
    {% if filter.qs.paginator %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if filter.qs.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ filter.qs.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% endif %}
            
            {% for i in filter.qs.paginator.page_range %}
                {% if filter.qs.number == i %}
                <li class="page-item active">
                    <span class="page-link">{{ i }}</span>
                </li>
                {% else %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a>
                </li>
                {% endif %}
            {% endfor %}
            
            {% if filter.qs.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ filter.qs.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <div class="text-center py-5">
        <div class="rounded-circle bg-light p-4 d-inline-block mb-3">
            <i class="bi bi-search text-muted fs-1"></i>
        </div>
        <h4 class="mb-2">No Employees Found</h4>
        <p class="text-muted mb-4">
            {% if filter.form.search.value or filter.form.department.value or filter.form.role.value %}
            Try adjusting your search or filter criteria
            {% else %}
            Start by adding your first employee to the system
            {% endif %}
        </p>
        <a href="{% url 'app:create' %}" class="btn gradient-btn me-2">
            <i class="bi bi-person-plus me-2"></i>Add Employee
        </a>
        <a href="?" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-clockwise me-2"></i>Clear Filters
        </a>
    </div>
    {% endif %}
</div>

{% else %}
<!-- Employee Dashboard (Remains the same) -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="glass-card p-4 h-100">
            {% for employee in object_list %}
            <div class="d-flex align-items-center mb-4">
                <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                    <i class="bi bi-person text-primary fs-2"></i>
                </div>
                <div>
                    <h3 class="mb-0">{{ employee.user.get_full_name }}</h3>
                    <p class="text-muted mb-0">{{ employee.user.email|default:"No email provided" }}</p>
                </div>
            </div>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-center p-3 bg-light rounded">
                        <div class="rounded-circle bg-success bg-opacity-10 p-2 me-3">
                            <i class="bi bi-building text-success"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Department</h6>
                            <p class="mb-0 fw-semibold">{{ employee.department }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center p-3 bg-light rounded">
                        <div class="rounded-circle bg-info bg-opacity-10 p-2 me-3">
                            <i class="bi bi-briefcase text-info"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Role</h6>
                            <p class="mb-0 fw-semibold">{{ employee.get_role_display }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center p-3 bg-light rounded">
                        <div class="rounded-circle bg-warning bg-opacity-10 p-2 me-3">
                            <i class="bi bi-person-check text-warning"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Reporting Manager</h6>
                            <p class="mb-0 fw-semibold">
                                {% if employee.reporting_to %}
                                    {{ employee.reporting_to.user.get_full_name }}
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center p-3 bg-light rounded">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-2 me-3">
                            <i class="bi bi-calendar-check text-primary"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Employee ID</h6>
                            <p class="mb-0 fw-semibold">EMP-{{ employee.id|stringformat:"04d" }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <h5 class="mb-3">Quick Actions</h5>
                <div class="d-flex flex-wrap gap-3">
                    <a href="{% url 'app:empupdate1' %}" class="btn btn-outline-warning px-4">
                        <i class="bi bi-pencil-square me-2"></i>Edit Profile
                    </a>
                    {% if request.user.employee.role != 'INTERN' %}
                    <a href="{% url 'app:perflist' %}" class="btn btn-outline-primary px-4">
                        <i class="bi bi-graph-up me-2"></i>Performance Review
                    </a>
                    {% endif %}
                    <a href="{% url 'app:learnplan' %}" class="btn btn-outline-success px-4">
                        <i class="bi bi-book me-2"></i>Learning Plans
                    </a>
                    {% with review=request.user.employee.performance_review.first %}
                    {% if review %}
                    <a href="{% url 'app:detailperf' review.id %}" class="btn btn-outline-info px-4">
                        <i class="bi bi-file-text me-2"></i>My Reviews
                    </a>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
            {% empty %}
            <div class="text-center py-5">
                <div class="rounded-circle bg-light p-4 d-inline-block mb-3">
                    <i class="bi bi-exclamation-circle text-warning fs-1"></i>
                </div>
                <h4 class="mb-2">Profile Not Found</h4>
                <p class="text-muted mb-4">Your employee profile needs to be set up</p>
                <a href="{% url 'app:empupdate1' %}" class="btn gradient-btn">
                    <i class="bi bi-person-plus me-2"></i>Complete Profile
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="glass-card p-4 mb-4">
            <h5 class="mb-3 d-flex align-items-center">
                <i class="bi bi-bell text-primary me-2"></i>Notifications
            </h5>
            <div class="list-group list-group-flush">
                <div class="list-group-item border-0 px-0 py-2">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-success bg-opacity-10 p-1 me-3">
                            <i class="bi bi-check-circle text-success"></i>
                        </div>
                        <div class="flex-grow-1">
                            <small class="text-muted">Today</small>
                            <p class="mb-0 small">Performance review submitted</p>
                        </div>
                    </div>
                </div>
                <div class="list-group-item border-0 px-0 py-2">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-warning bg-opacity-10 p-1 me-3">
                            <i class="bi bi-clock text-warning"></i>
                        </div>
                        <div class="flex-grow-1">
                            <small class="text-muted">Yesterday</small>
                            <p class="mb-0 small">Learning plan needs update</p>
                        </div>
                    </div>
                </div>
                <div class="list-group-item border-0 px-0 py-2">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-info bg-opacity-10 p-1 me-3">
                            <i class="bi bi-info-circle text-info"></i>
                        </div>
                        <div class="flex-grow-1">
                            <small class="text-muted">2 days ago</small>
                            <p class="mb-0 small">New company policy released</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="glass-card p-4">
            <h5 class="mb-3 d-flex align-items-center">
                <i class="bi bi-calendar-event text-primary me-2"></i>Upcoming Events
            </h5>
            <div class="list-group list-group-flush">
                <div class="list-group-item border-0 px-0 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0 small">Team Meeting</p>
                        </div>
                        {% if meeting %}
                        <span class="badge bg-primary bg-opacity-10 text-primary">{{ meeting.first.schedule_meeting|date:'D d M Y' }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="list-group-item border-0 px-0 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">This Friday</small>
                            <p class="mb-0 small">Performance Review Due</p>
                        </div>
                        <span class="badge bg-warning bg-opacity-10 text-warning">5:00 PM</span>
                    </div>
                </div>
                <div class="list-group-item border-0 px-0 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Next Week</small>
                            <p class="mb-0 small">Training Session</p>
                        </div>
                        <span class="badge bg-success bg-opacity-10 text-success">2:00 PM</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if request.user.employee.role != 'CEO' %}
<div class="row mt-4">
    <div class="col-12">
        <div class="glass-card p-4">
            <h5 class="mb-3">Quick Stats</h5>
            <div class="row">
                <div class="col-md-3 text-center">
                    <div class="p-3">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3 d-inline-block mb-2">
                            <i class="bi bi-check-circle text-primary fs-3"></i>
                        </div>
                        <h3 class="mb-1">24</h3>
                        <p class="text-muted mb-0">Tasks Completed</p>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="p-3">
                        <div class="rounded-circle bg-success bg-opacity-10 p-3 d-inline-block mb-2">
                            <i class="bi bi-clock text-success fs-3"></i>
                        </div>
                        <h3 class="mb-1">{{ pending }}</h3>
                        <p class="text-muted mb-0">Pending Reviews</p>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="p-3">
                        <div class="rounded-circle bg-warning bg-opacity-10 p-3 d-inline-block mb-2">
                            <i class="bi bi-book text-warning fs-3"></i>
                        </div>
                        <h3 class="mb-1">12</h3>
                        <p class="text-muted mb-0">Learning Hours</p>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <div class="p-3">
                        <div class="rounded-circle bg-info bg-opacity-10 p-3 d-inline-block mb-2">
                            <i class="bi bi-star text-info fs-3"></i>
                        </div>
                        <h3 class="mb-1">{{ avg_rating }}</h3>
                        <p class="text-muted mb-0">Average Rating</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- JavaScript for better filter UX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit on select change
    const selects = document.querySelectorAll('select[name="department"], select[name="role"]');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });
    
    // Quick filter buttons - update form and submit
    const quickFilterButtons = document.querySelectorAll('.btn-group .btn:not(.btn-outline-secondary)');
    quickFilterButtons.forEach(button => {
        if (button.type === 'submit') {
            button.addEventListener('click', function(e) {
                // Remove other role values from URL
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.delete('role');
                
                // Update form action
                const form = this.closest('form');
                const action = window.location.pathname + '?' + urlParams.toString();
                form.action = action;
            });
        }
    });
    
    // Clear button
    const clearBtn = document.querySelector('a[href="?"]');
    if (clearBtn) {
        clearBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = '?';
        });
    }
    
    // Highlight search term in table
    const searchTerm = "{{ filter.form.search.value|default:''|escapejs }}";
    if (searchTerm) {
        const tableCells = document.querySelectorAll('tbody td');
        tableCells.forEach(cell => {
            const html = cell.innerHTML;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            const highlighted = html.replace(regex, '<mark class="bg-warning">$1</mark>');
            cell.innerHTML = highlighted;
        });
    }
});

function applyRoleFilter(roleValue) {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Update role parameter
    if (roleValue) {
        urlParams.set('role', roleValue);
    } else {
        urlParams.delete('role');
    }
    
    // Redirect with new parameters
    window.location.href = '?' + urlParams.toString();
}

function clearRoleFilter() {
    // Get current URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Remove role parameter
    urlParams.delete('role');
    
    // Redirect without role filter
    window.location.href = '?' + urlParams.toString();
}

// Also update the main form submission to work with quick filters
document.addEventListener('DOMContentLoaded', function() {
    const mainForm = document.querySelector('form[method="get"]');
    
    if (mainForm) {
        // Store original form action
        const originalAction = mainForm.action || window.location.pathname;
        
        // Update form submission to include all parameters
        mainForm.addEventListener('submit', function(e) {
            // Don't prevent default - let form submit normally
            // Just make sure role is included if set
            const urlParams = new URLSearchParams(window.location.search);
            const currentRole = urlParams.get('role');
            
            if (currentRole && !this.querySelector('[name="role"]')) {
                // Add hidden role input if not present
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'role';
                hiddenInput.value = currentRole;
                this.appendChild(hiddenInput);
            }
        });
    }
});
</script>
{% endblock %}